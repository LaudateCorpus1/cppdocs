


<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Program Listing for File ivalue.h &mdash; PyTorch master documentation</title>
  

  
  
  
  
    <link rel="canonical" href="https://pytorch.org/docs/stable/api/program_listing_file_aten_src_ATen_core_ivalue.h.html"/>
  

  

  
  
    

  

  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <!-- <link rel="stylesheet" href="../_static/pygments.css" type="text/css" /> -->
  <link rel="stylesheet" href="../_static/collapsible-lists/css/tree_view.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 

  
  <script src="../_static/js/modernizr.min.js"></script>
</head>

<div class="container-fluid header-holder tutorials-header" id="header-holder">
  <div class="container">
    <div class="header-container">
      <a class="header-logo" href="https://pytorch.org/" aria-label="PyTorch"></a>

      <div class="main-menu">
        <ul>
          <li>
            <a href="https://pytorch.org/get-started">Get Started</a>
          </li>

          <li>
            <a href="https://pytorch.org/features">Features</a>
          </li>

          <li>
            <a href="https://pytorch.org/ecosystem">Ecosystem</a>
          </li>

          <li>
            <a href="https://pytorch.org/blog/">Blog</a>
          </li>

          <li>
            <a href="https://pytorch.org/tutorials">Tutorials</a>
          </li>

          <li class="active">
            <a href="https://pytorch.org/docs/stable/index.html">Docs</a>
          </li>

          <li>
            <a href="https://pytorch.org/resources">Resources</a>
          </li>

          <li>
            <a href="https://github.com/pytorch/pytorch">Github</a>
          </li>
        </ul>
      </div>

      <a class="main-menu-open-button" href="#" data-behavior="open-mobile-menu"></a>
    </div>

  </div>
</div>


<body class="pytorch-body">

   

    

    <div class="table-of-contents-link-wrapper">
      <span>Table of Contents</span>
      <a href="#" class="toggle-table-of-contents" data-behavior="toggle-table-of-contents"></a>
    </div>

    <nav data-toggle="wy-nav-shift" class="pytorch-left-menu" id="pytorch-left-menu">
      <div class="pytorch-side-scroll">
        <div class="pytorch-menu pytorch-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          <div class="pytorch-left-menu-search">
            

            
              
              
                <div class="version">
                  master
                </div>
              
            

            


  


<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search Docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

            
          </div>

          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../installing.html">Installing C++ Distributions of PyTorch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../frontend.html">The C++ Frontend</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contributing.html">Contributing to PyTorch</a></li>
<li class="toctree-l1"><a class="reference internal" href="library_root.html">Library API</a></li>
</ul>
<p class="caption"><span class="caption-text">Notes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../notes/faq.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../notes/tensor_basics.html">Tensor Basics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../notes/tensor_creation.html">Tensor Creation API</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <div class="pytorch-container">
      <div class="pytorch-page-level-bar" id="pytorch-page-level-bar">
        <div class="pytorch-breadcrumbs-wrapper">
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="pytorch-breadcrumbs">
    
      <li>
        <a href="../index.html">
          
            Docs
          
        </a> &gt;
      </li>

        
      <li>Program Listing for File ivalue.h</li>
    
    
      <li class="pytorch-breadcrumbs-aside">
        
            
            
              <!-- User defined GitHub URL -->
              <a href="https://github.com/pytorch/pytorch" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
</div>
        </div>

        <div class="pytorch-shortcuts-wrapper" id="pytorch-shortcuts-wrapper">
          Shortcuts
        </div>
      </div>

      <section data-toggle="wy-nav-shift" id="pytorch-content-wrap" class="pytorch-content-wrap">
        <div class="pytorch-content-left">

        
          
          <div class="rst-content">
          
            <div role="main" class="main-content" itemscope="itemscope" itemtype="http://schema.org/Article">
             <article itemprop="articleBody" id="pytorch-article" class="pytorch-article">
              
  <div class="section" id="program-listing-for-file-ivalue-h">
<span id="program-listing-file-aten-src-aten-core-ivalue-h"></span><h1>Program Listing for File ivalue.h<a class="headerlink" href="#program-listing-for-file-ivalue-h" title="Permalink to this headline">¶</a></h1>
<p>↰ <a class="reference internal" href="file_aten_src_ATen_core_ivalue.h.html#file-aten-src-aten-core-ivalue-h"><span class="std std-ref">Return to documentation for file</span></a> (<code class="docutils literal notranslate"><span class="pre">aten/src/ATen/core/ivalue.h</span></code>)</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#pragma once</span>

<span class="cp">#include</span> <span class="cpf">&lt;ATen/core/blob.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;c10/util/intrusive_ptr.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;ATen/core/Tensor.h&gt;</span><span class="cp"></span>

<span class="k">namespace</span> <span class="n">torch</span> <span class="p">{</span>
<span class="k">namespace</span> <span class="n">jit</span> <span class="p">{</span>
<span class="k">struct</span> <span class="n">Function</span><span class="p">;</span>
<span class="p">}</span> <span class="c1">// namespace jit</span>
<span class="p">}</span> <span class="c1">// namespace torch</span>
<span class="k">namespace</span> <span class="n">c10</span> <span class="p">{</span>
<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">Key</span><span class="p">,</span> <span class="k">class</span> <span class="nc">Value</span><span class="o">&gt;</span> <span class="k">class</span> <span class="nc">Dict</span><span class="p">;</span>
<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span> <span class="k">class</span> <span class="nc">List</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">IValue</span><span class="p">;</span>
<span class="k">namespace</span> <span class="n">ivalue</span> <span class="p">{</span>
<span class="k">struct</span> <span class="n">Tuple</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">Future</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">ConstantString</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">GenericDict</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">Object</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// IValue is the generic tagged union used by the interpreter to hold</span>
<span class="c1">// all value types.</span>
<span class="c1">// It is a 16-byte object with an 8-byte payload and an 8-byte tag.</span>
<span class="c1">// The tag is currently 4 bytes to determine the type, and 1 byte</span>
<span class="c1">// to mark whether that type is a subtype of c10::intrusive_ptr_target and needs</span>
<span class="c1">// retain/release calls.</span>

<span class="cp">#define TORCH_FORALL_TAGS(_) \</span>
<span class="cp">  _(None) \</span>
<span class="cp">  _(Tensor) \</span>
<span class="cp">  _(Double) \</span>
<span class="cp">  _(Int) \</span>
<span class="cp">  _(Bool) \</span>
<span class="cp">  _(Tuple) \</span>
<span class="cp">  _(IntList) \</span>
<span class="cp">  _(DoubleList) \</span>
<span class="cp">  _(BoolList) \</span>
<span class="cp">  _(String) \</span>
<span class="cp">  _(TensorList) \</span>
<span class="cp">  _(Blob) \</span>
<span class="cp">  _(GenericList) \</span>
<span class="cp">  _(GenericDict) \</span>
<span class="cp">  _(Future) \</span>
<span class="cp">  _(Device) \</span>
<span class="cp">  _(Uninitialized) \</span>
<span class="cp">  _(Object)</span>

<span class="k">struct</span> <span class="n">CAFFE2_API</span> <span class="n">IValue</span> <span class="k">final</span> <span class="p">{</span>
  <span class="n">IValue</span><span class="p">()</span> <span class="o">:</span> <span class="n">payload</span><span class="p">{</span><span class="mi">0</span><span class="p">},</span> <span class="n">tag</span><span class="p">(</span><span class="n">Tag</span><span class="o">::</span><span class="n">None</span><span class="p">),</span> <span class="n">is_intrusive_ptr</span><span class="p">(</span><span class="nb">false</span><span class="p">)</span> <span class="p">{}</span>
  <span class="n">IValue</span><span class="p">(</span><span class="k">const</span> <span class="n">IValue</span><span class="o">&amp;</span> <span class="n">rhs</span><span class="p">)</span>
      <span class="o">:</span> <span class="n">IValue</span><span class="p">(</span><span class="n">rhs</span><span class="p">.</span><span class="n">payload</span><span class="p">,</span> <span class="n">rhs</span><span class="p">.</span><span class="n">tag</span><span class="p">,</span> <span class="n">rhs</span><span class="p">.</span><span class="n">is_intrusive_ptr</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">is_intrusive_ptr</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">c10</span><span class="o">::</span><span class="n">raw</span><span class="o">::</span><span class="n">intrusive_ptr</span><span class="o">::</span><span class="n">incref</span><span class="p">(</span><span class="n">payload</span><span class="p">.</span><span class="n">as_intrusive_ptr</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="n">IValue</span><span class="p">(</span><span class="n">IValue</span><span class="o">&amp;&amp;</span> <span class="n">rhs</span><span class="p">)</span> <span class="k">noexcept</span> <span class="o">:</span> <span class="n">IValue</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">swap</span><span class="p">(</span><span class="n">rhs</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="o">~</span><span class="n">IValue</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">is_intrusive_ptr</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">c10</span><span class="o">::</span><span class="n">raw</span><span class="o">::</span><span class="n">intrusive_ptr</span><span class="o">::</span><span class="n">decref</span><span class="p">(</span><span class="n">payload</span><span class="p">.</span><span class="n">as_intrusive_ptr</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="n">IValue</span> <span class="o">&amp;</span> <span class="k">operator</span><span class="o">=</span><span class="p">(</span><span class="n">IValue</span> <span class="o">&amp;&amp;</span> <span class="n">rhs</span><span class="p">)</span> <span class="o">&amp;</span> <span class="k">noexcept</span> <span class="p">{</span>
    <span class="n">IValue</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">rhs</span><span class="p">)).</span><span class="n">swap</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">);</span> <span class="c1">// this also sets rhs to None</span>
    <span class="k">return</span> <span class="o">*</span><span class="k">this</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">IValue</span> <span class="o">&amp;</span> <span class="k">operator</span><span class="o">=</span><span class="p">(</span><span class="n">IValue</span> <span class="k">const</span> <span class="o">&amp;</span> <span class="n">rhs</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">{</span>
    <span class="n">IValue</span><span class="p">(</span><span class="n">rhs</span><span class="p">).</span><span class="n">swap</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">);</span>
    <span class="k">return</span> <span class="o">*</span><span class="k">this</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kt">void</span> <span class="n">dump</span><span class="p">()</span> <span class="k">const</span><span class="p">;</span>

  <span class="kt">bool</span> <span class="nf">isAliasOf</span><span class="p">(</span><span class="k">const</span> <span class="n">IValue</span><span class="o">&amp;</span> <span class="n">rhs</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">tag</span> <span class="o">!=</span> <span class="n">rhs</span><span class="p">.</span><span class="n">tag</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// Trivially don&#39;t alias if the type is different</span>
      <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">is_intrusive_ptr</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// Primitive types don&#39;t alias anything</span>
      <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">AT_ASSERT</span><span class="p">(</span><span class="n">rhs</span><span class="p">.</span><span class="n">is_intrusive_ptr</span><span class="p">);</span>

    <span class="c1">// Tensors should be compared based on internal storage</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">isTensor</span><span class="p">())</span> <span class="p">{</span>
      <span class="k">const</span> <span class="k">auto</span> <span class="n">thisTensor</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">toTensor</span><span class="p">();</span>
      <span class="k">const</span> <span class="k">auto</span> <span class="n">rhsTensor</span> <span class="o">=</span> <span class="n">rhs</span><span class="p">.</span><span class="n">toTensor</span><span class="p">();</span>
      <span class="k">return</span> <span class="n">thisTensor</span><span class="p">.</span><span class="n">is_alias_of</span><span class="p">(</span><span class="n">rhsTensor</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// Other types can be compared by their ptr value</span>
    <span class="k">return</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">payload</span><span class="p">.</span><span class="n">as_intrusive_ptr</span> <span class="o">==</span> <span class="n">rhs</span><span class="p">.</span><span class="n">payload</span><span class="p">.</span><span class="n">as_intrusive_ptr</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="kt">void</span> <span class="nf">swap</span><span class="p">(</span><span class="n">IValue</span> <span class="o">&amp;</span> <span class="n">rhs</span><span class="p">)</span> <span class="k">noexcept</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">swap</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">rhs</span><span class="p">.</span><span class="n">payload</span><span class="p">);</span>
    <span class="n">std</span><span class="o">::</span><span class="n">swap</span><span class="p">(</span><span class="n">is_intrusive_ptr</span><span class="p">,</span> <span class="n">rhs</span><span class="p">.</span><span class="n">is_intrusive_ptr</span><span class="p">);</span>
    <span class="n">std</span><span class="o">::</span><span class="n">swap</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">rhs</span><span class="p">.</span><span class="n">tag</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">// Accessors for subtypes are arranged together below</span>
  <span class="c1">// While some of these accessors could be generated through templates,</span>
  <span class="c1">// we prefer to write them manually for clarity</span>

  <span class="c1">// Tensor</span>
  <span class="n">IValue</span><span class="p">(</span><span class="n">at</span><span class="o">::</span><span class="n">Tensor</span> <span class="n">t</span><span class="p">)</span>
  <span class="o">:</span> <span class="n">tag</span><span class="p">(</span><span class="n">Tag</span><span class="o">::</span><span class="n">Tensor</span><span class="p">),</span> <span class="n">is_intrusive_ptr</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">defined</span><span class="p">())</span>  <span class="p">{</span>
    <span class="c1">// Note: the undefined tensor is not refcounted, so while it</span>
    <span class="c1">// is tagged as a tensor, is_intrusive_ptr is set to false.</span>
    <span class="c1">// This is not an optional optimization: our incref call</span>
    <span class="c1">// *will not* do the right thing when called on an</span>
    <span class="c1">// undefined tensor.</span>
    <span class="n">payload</span><span class="p">.</span><span class="n">as_intrusive_ptr</span> <span class="o">=</span> <span class="n">t</span><span class="p">.</span><span class="n">unsafeReleaseTensorImpl</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="kt">bool</span> <span class="n">isTensor</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">Tag</span><span class="o">::</span><span class="n">Tensor</span> <span class="o">==</span> <span class="n">tag</span><span class="p">;</span> <span class="p">}</span>
  <span class="n">at</span><span class="o">::</span><span class="n">Tensor</span> <span class="n">toTensor</span><span class="p">()</span> <span class="o">&amp;&amp;</span><span class="p">;</span>
  <span class="n">at</span><span class="o">::</span><span class="n">Tensor</span> <span class="n">toTensor</span><span class="p">()</span> <span class="k">const</span> <span class="o">&amp;</span><span class="p">;</span>
  <span class="n">at</span><span class="o">::</span><span class="n">TensorImpl</span><span class="o">*</span> <span class="n">unsafeToTensorImpl</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">at</span><span class="o">::</span><span class="n">TensorImpl</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">payload</span><span class="p">.</span><span class="n">as_intrusive_ptr</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">const</span> <span class="n">IValue</span><span class="o">&amp;</span> <span class="n">toIValue</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="o">*</span><span class="k">this</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">IValue</span><span class="o">&amp;</span> <span class="n">toIValue</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="o">*</span><span class="k">this</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">IValue</span><span class="p">(</span><span class="n">intrusive_ptr</span><span class="o">&lt;</span><span class="n">caffe2</span><span class="o">::</span><span class="n">Blob</span><span class="o">&gt;</span> <span class="n">blob</span><span class="p">)</span>
  <span class="o">:</span> <span class="n">tag</span><span class="p">(</span><span class="n">Tag</span><span class="o">::</span><span class="n">Blob</span><span class="p">),</span> <span class="n">is_intrusive_ptr</span><span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// TODO (after Tensor merge) If we pass in a Blob holding a Tensor, extract</span>
    <span class="c1">// and store it as a Tensor instead.</span>
    <span class="n">payload</span><span class="p">.</span><span class="n">as_intrusive_ptr</span> <span class="o">=</span> <span class="n">blob</span><span class="p">.</span><span class="n">release</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="kt">bool</span> <span class="n">isBlob</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">Tag</span><span class="o">::</span><span class="n">Blob</span> <span class="o">==</span> <span class="n">tag</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">c10</span><span class="o">::</span><span class="n">intrusive_ptr</span><span class="o">&lt;</span><span class="n">caffe2</span><span class="o">::</span><span class="n">Blob</span><span class="o">&gt;</span> <span class="n">toBlob</span><span class="p">()</span> <span class="o">&amp;&amp;</span><span class="p">;</span>
  <span class="n">c10</span><span class="o">::</span><span class="n">intrusive_ptr</span><span class="o">&lt;</span><span class="n">caffe2</span><span class="o">::</span><span class="n">Blob</span><span class="o">&gt;</span> <span class="n">toBlob</span><span class="p">()</span> <span class="k">const</span> <span class="o">&amp;</span><span class="p">;</span>

  <span class="c1">// Tuple</span>
  <span class="n">IValue</span><span class="p">(</span><span class="n">c10</span><span class="o">::</span><span class="n">intrusive_ptr</span><span class="o">&lt;</span><span class="n">ivalue</span><span class="o">::</span><span class="n">Tuple</span><span class="o">&gt;</span> <span class="n">v</span><span class="p">);</span>
  <span class="kt">bool</span> <span class="nf">isTuple</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">Tag</span><span class="o">::</span><span class="n">Tuple</span> <span class="o">==</span> <span class="n">tag</span><span class="p">;</span> <span class="p">}</span>
  <span class="n">c10</span><span class="o">::</span><span class="n">intrusive_ptr</span><span class="o">&lt;</span><span class="n">ivalue</span><span class="o">::</span><span class="n">Tuple</span><span class="o">&gt;</span> <span class="n">toTuple</span><span class="p">()</span> <span class="o">&amp;&amp;</span><span class="p">;</span>
  <span class="n">c10</span><span class="o">::</span><span class="n">intrusive_ptr</span><span class="o">&lt;</span><span class="n">ivalue</span><span class="o">::</span><span class="n">Tuple</span><span class="o">&gt;</span> <span class="n">toTuple</span><span class="p">()</span> <span class="k">const</span> <span class="o">&amp;</span><span class="p">;</span>

  <span class="c1">// Double</span>
  <span class="n">IValue</span><span class="p">(</span><span class="kt">double</span> <span class="n">d</span><span class="p">)</span>
  <span class="o">:</span> <span class="n">tag</span><span class="p">(</span><span class="n">Tag</span><span class="o">::</span><span class="n">Double</span><span class="p">),</span> <span class="n">is_intrusive_ptr</span><span class="p">(</span><span class="nb">false</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">payload</span><span class="p">.</span><span class="n">as_double</span> <span class="o">=</span> <span class="n">d</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="kt">bool</span> <span class="n">isDouble</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">Tag</span><span class="o">::</span><span class="n">Double</span> <span class="o">==</span> <span class="n">tag</span><span class="p">;</span> <span class="p">}</span>
  <span class="kt">double</span> <span class="n">toDouble</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
    <span class="n">AT_ASSERT</span><span class="p">(</span><span class="n">isDouble</span><span class="p">());</span>
    <span class="k">return</span> <span class="n">payload</span><span class="p">.</span><span class="n">as_double</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">// Future</span>
  <span class="n">IValue</span><span class="p">(</span><span class="n">c10</span><span class="o">::</span><span class="n">intrusive_ptr</span><span class="o">&lt;</span><span class="n">ivalue</span><span class="o">::</span><span class="n">Future</span><span class="o">&gt;</span> <span class="n">v</span><span class="p">);</span>
  <span class="kt">bool</span> <span class="nf">isFuture</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">Tag</span><span class="o">::</span><span class="n">Future</span> <span class="o">==</span> <span class="n">tag</span><span class="p">;</span> <span class="p">}</span>
  <span class="n">c10</span><span class="o">::</span><span class="n">intrusive_ptr</span><span class="o">&lt;</span><span class="n">ivalue</span><span class="o">::</span><span class="n">Future</span><span class="o">&gt;</span> <span class="n">toFuture</span><span class="p">()</span> <span class="o">&amp;&amp;</span><span class="p">;</span>
  <span class="n">c10</span><span class="o">::</span><span class="n">intrusive_ptr</span><span class="o">&lt;</span><span class="n">ivalue</span><span class="o">::</span><span class="n">Future</span><span class="o">&gt;</span> <span class="n">toFuture</span><span class="p">()</span> <span class="k">const</span> <span class="o">&amp;</span><span class="p">;</span>

  <span class="c1">// Int</span>
  <span class="n">IValue</span><span class="p">(</span><span class="kt">int64_t</span> <span class="n">i</span><span class="p">)</span>
  <span class="o">:</span> <span class="n">tag</span><span class="p">(</span><span class="n">Tag</span><span class="o">::</span><span class="n">Int</span><span class="p">),</span> <span class="n">is_intrusive_ptr</span><span class="p">(</span><span class="nb">false</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">payload</span><span class="p">.</span><span class="n">as_int</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">// allow you to pass literals (3, 4) without ambiguity</span>
  <span class="n">IValue</span><span class="p">(</span><span class="kt">int32_t</span> <span class="n">i</span><span class="p">)</span>
  <span class="o">:</span> <span class="n">IValue</span><span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int64_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="p">{}</span>

  <span class="kt">bool</span> <span class="n">isInt</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">Tag</span><span class="o">::</span><span class="n">Int</span> <span class="o">==</span> <span class="n">tag</span><span class="p">;</span> <span class="p">}</span>

  <span class="kt">int64_t</span> <span class="n">toInt</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
    <span class="n">AT_ASSERT</span><span class="p">(</span><span class="n">isInt</span><span class="p">());</span>
    <span class="k">return</span> <span class="n">payload</span><span class="p">.</span><span class="n">as_int</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">// Bool</span>
  <span class="n">IValue</span><span class="p">(</span><span class="kt">bool</span> <span class="n">b</span><span class="p">)</span>
  <span class="o">:</span> <span class="n">tag</span><span class="p">(</span><span class="n">Tag</span><span class="o">::</span><span class="n">Bool</span><span class="p">),</span> <span class="n">is_intrusive_ptr</span><span class="p">(</span><span class="nb">false</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">payload</span><span class="p">.</span><span class="n">as_bool</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>
  <span class="p">}</span>
   <span class="kt">bool</span> <span class="n">isBool</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">Tag</span><span class="o">::</span><span class="n">Bool</span> <span class="o">==</span> <span class="n">tag</span><span class="p">;</span> <span class="p">}</span>
   <span class="kt">bool</span> <span class="n">toBool</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
    <span class="n">AT_ASSERT</span><span class="p">(</span><span class="n">isBool</span><span class="p">());</span>
    <span class="k">return</span> <span class="n">payload</span><span class="p">.</span><span class="n">as_bool</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">// IntList</span>
  <span class="n">IValue</span><span class="p">(</span><span class="n">c10</span><span class="o">::</span><span class="n">List</span><span class="o">&lt;</span><span class="kt">int64_t</span><span class="o">&gt;</span> <span class="n">v</span><span class="p">);</span>
  <span class="n">IValue</span><span class="p">(</span><span class="n">c10</span><span class="o">::</span><span class="n">ArrayRef</span><span class="o">&lt;</span><span class="kt">int64_t</span><span class="o">&gt;</span> <span class="n">v</span><span class="p">);</span>
  <span class="n">IValue</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int64_t</span><span class="o">&gt;</span> <span class="n">v</span><span class="p">);</span>
  <span class="kt">bool</span> <span class="nf">isIntList</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">Tag</span><span class="o">::</span><span class="n">IntList</span> <span class="o">==</span> <span class="n">tag</span><span class="p">;</span> <span class="p">}</span>
  <span class="n">c10</span><span class="o">::</span><span class="n">List</span><span class="o">&lt;</span><span class="kt">int64_t</span><span class="o">&gt;</span> <span class="n">toIntList</span><span class="p">()</span> <span class="o">&amp;&amp;</span><span class="p">;</span>
  <span class="n">c10</span><span class="o">::</span><span class="n">List</span><span class="o">&lt;</span><span class="kt">int64_t</span><span class="o">&gt;</span> <span class="n">toIntList</span><span class="p">()</span> <span class="k">const</span> <span class="o">&amp;</span><span class="p">;</span>
  <span class="n">c10</span><span class="o">::</span><span class="n">ArrayRef</span><span class="o">&lt;</span><span class="kt">int64_t</span><span class="o">&gt;</span> <span class="n">toIntListRef</span><span class="p">()</span> <span class="k">const</span><span class="p">;</span>

  <span class="c1">// ConstantString</span>
  <span class="n">IValue</span><span class="p">(</span><span class="n">c10</span><span class="o">::</span><span class="n">intrusive_ptr</span><span class="o">&lt;</span><span class="n">ivalue</span><span class="o">::</span><span class="n">ConstantString</span><span class="o">&gt;</span> <span class="n">v</span><span class="p">);</span>
  <span class="n">IValue</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">v</span><span class="p">);</span>
  <span class="n">IValue</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">v</span><span class="p">)</span><span class="o">:</span> <span class="n">IValue</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="p">{}</span>
  <span class="kt">bool</span> <span class="n">isString</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">Tag</span><span class="o">::</span><span class="n">String</span> <span class="o">==</span> <span class="n">tag</span><span class="p">;</span> <span class="p">}</span>
  <span class="n">c10</span><span class="o">::</span><span class="n">intrusive_ptr</span><span class="o">&lt;</span><span class="n">ivalue</span><span class="o">::</span><span class="n">ConstantString</span><span class="o">&gt;</span> <span class="n">toString</span><span class="p">()</span> <span class="o">&amp;&amp;</span><span class="p">;</span>
  <span class="n">c10</span><span class="o">::</span><span class="n">intrusive_ptr</span><span class="o">&lt;</span><span class="n">ivalue</span><span class="o">::</span><span class="n">ConstantString</span><span class="o">&gt;</span> <span class="n">toString</span><span class="p">()</span> <span class="k">const</span> <span class="o">&amp;</span><span class="p">;</span>
  <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">toStringRef</span><span class="p">()</span> <span class="k">const</span><span class="p">;</span>

  <span class="c1">// DoubleList</span>
  <span class="n">IValue</span><span class="p">(</span><span class="n">c10</span><span class="o">::</span><span class="n">List</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="n">v</span><span class="p">);</span>
  <span class="n">IValue</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="n">v</span><span class="p">);</span>
  <span class="kt">bool</span> <span class="nf">isDoubleList</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">Tag</span><span class="o">::</span><span class="n">DoubleList</span> <span class="o">==</span> <span class="n">tag</span><span class="p">;</span> <span class="p">}</span>
  <span class="n">c10</span><span class="o">::</span><span class="n">List</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="n">toDoubleList</span><span class="p">()</span> <span class="o">&amp;&amp;</span><span class="p">;</span>
  <span class="n">c10</span><span class="o">::</span><span class="n">List</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="n">toDoubleList</span><span class="p">()</span> <span class="k">const</span> <span class="o">&amp;</span><span class="p">;</span>
  <span class="n">c10</span><span class="o">::</span><span class="n">ArrayRef</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="n">toDoubleListRef</span><span class="p">()</span> <span class="k">const</span><span class="p">;</span>

  <span class="c1">// BoolList</span>
  <span class="n">IValue</span><span class="p">(</span><span class="n">c10</span><span class="o">::</span><span class="n">List</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span> <span class="n">v</span><span class="p">);</span>
  <span class="n">IValue</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span> <span class="n">v</span><span class="p">);</span>
  <span class="kt">bool</span> <span class="nf">isBoolList</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">Tag</span><span class="o">::</span><span class="n">BoolList</span> <span class="o">==</span> <span class="n">tag</span><span class="p">;</span> <span class="p">}</span>
  <span class="n">c10</span><span class="o">::</span><span class="n">List</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span> <span class="n">toBoolList</span><span class="p">()</span> <span class="o">&amp;&amp;</span><span class="p">;</span>
  <span class="n">c10</span><span class="o">::</span><span class="n">List</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span> <span class="n">toBoolList</span><span class="p">()</span> <span class="k">const</span> <span class="o">&amp;</span><span class="p">;</span>

  <span class="c1">//TensorList</span>
  <span class="n">IValue</span><span class="p">(</span><span class="n">c10</span><span class="o">::</span><span class="n">List</span><span class="o">&lt;</span><span class="n">at</span><span class="o">::</span><span class="n">Tensor</span><span class="o">&gt;</span> <span class="n">v</span><span class="p">);</span>
  <span class="n">IValue</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">at</span><span class="o">::</span><span class="n">Tensor</span><span class="o">&gt;</span> <span class="n">v</span><span class="p">);</span>
  <span class="kt">bool</span> <span class="nf">isTensorList</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">Tag</span><span class="o">::</span><span class="n">TensorList</span> <span class="o">==</span> <span class="n">tag</span><span class="p">;</span> <span class="p">}</span>
  <span class="n">c10</span><span class="o">::</span><span class="n">List</span><span class="o">&lt;</span><span class="n">at</span><span class="o">::</span><span class="n">Tensor</span><span class="o">&gt;</span> <span class="n">toTensorList</span><span class="p">()</span> <span class="o">&amp;&amp;</span><span class="p">;</span>
  <span class="n">c10</span><span class="o">::</span><span class="n">List</span><span class="o">&lt;</span><span class="n">at</span><span class="o">::</span><span class="n">Tensor</span><span class="o">&gt;</span> <span class="n">toTensorList</span><span class="p">()</span> <span class="k">const</span> <span class="o">&amp;</span><span class="p">;</span>
  <span class="n">c10</span><span class="o">::</span><span class="n">ArrayRef</span><span class="o">&lt;</span><span class="n">at</span><span class="o">::</span><span class="n">Tensor</span><span class="o">&gt;</span> <span class="n">toTensorListRef</span><span class="p">()</span> <span class="k">const</span><span class="p">;</span>

  <span class="c1">//GenericList</span>
  <span class="n">IValue</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">IValue</span><span class="o">&gt;</span> <span class="n">v</span><span class="p">);</span>
  <span class="n">IValue</span><span class="p">(</span><span class="n">c10</span><span class="o">::</span><span class="n">List</span><span class="o">&lt;</span><span class="n">IValue</span><span class="o">&gt;</span> <span class="n">v</span><span class="p">);</span>
  <span class="kt">bool</span> <span class="nf">isGenericList</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">Tag</span><span class="o">::</span><span class="n">GenericList</span> <span class="o">==</span> <span class="n">tag</span><span class="p">;</span> <span class="p">}</span>
  <span class="n">c10</span><span class="o">::</span><span class="n">List</span><span class="o">&lt;</span><span class="n">IValue</span><span class="o">&gt;</span> <span class="n">toGenericList</span><span class="p">()</span> <span class="o">&amp;&amp;</span><span class="p">;</span>
  <span class="n">c10</span><span class="o">::</span><span class="n">List</span><span class="o">&lt;</span><span class="n">IValue</span><span class="o">&gt;</span> <span class="n">toGenericList</span><span class="p">()</span> <span class="k">const</span> <span class="o">&amp;</span><span class="p">;</span>
  <span class="n">c10</span><span class="o">::</span><span class="n">ArrayRef</span><span class="o">&lt;</span><span class="n">IValue</span><span class="o">&gt;</span> <span class="n">toGenericListRef</span><span class="p">()</span> <span class="k">const</span><span class="p">;</span>

  <span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span>
  <span class="n">IValue</span><span class="p">(</span><span class="n">c10</span><span class="o">::</span><span class="n">List</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">v</span><span class="p">);</span>
  <span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span>
  <span class="n">IValue</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">v</span><span class="p">);</span>

  <span class="c1">// GenericDict</span>
  <span class="n">IValue</span><span class="p">(</span><span class="n">c10</span><span class="o">::</span><span class="n">Dict</span><span class="o">&lt;</span><span class="n">IValue</span><span class="p">,</span> <span class="n">IValue</span><span class="o">&gt;</span> <span class="n">v</span><span class="p">);</span>
  <span class="kt">bool</span> <span class="nf">isGenericDict</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">Tag</span><span class="o">::</span><span class="n">GenericDict</span> <span class="o">==</span> <span class="n">tag</span><span class="p">;</span> <span class="p">}</span>
  <span class="n">c10</span><span class="o">::</span><span class="n">Dict</span><span class="o">&lt;</span><span class="n">IValue</span><span class="p">,</span> <span class="n">IValue</span><span class="o">&gt;</span> <span class="n">toGenericDict</span><span class="p">()</span> <span class="o">&amp;&amp;</span><span class="p">;</span>
  <span class="n">c10</span><span class="o">::</span><span class="n">Dict</span><span class="o">&lt;</span><span class="n">IValue</span><span class="p">,</span> <span class="n">IValue</span><span class="o">&gt;</span> <span class="n">toGenericDict</span><span class="p">()</span> <span class="k">const</span> <span class="o">&amp;</span><span class="p">;</span>

  <span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">Key</span><span class="p">,</span> <span class="k">class</span> <span class="nc">Value</span><span class="o">&gt;</span>
  <span class="n">IValue</span><span class="p">(</span><span class="n">c10</span><span class="o">::</span><span class="n">Dict</span><span class="o">&lt;</span><span class="n">Key</span><span class="p">,</span> <span class="n">Value</span><span class="o">&gt;</span> <span class="n">v</span><span class="p">);</span>

  <span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">Key</span><span class="p">,</span> <span class="k">class</span> <span class="nc">Value</span><span class="o">&gt;</span>
  <span class="n">IValue</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">unordered_map</span><span class="o">&lt;</span><span class="n">Key</span><span class="p">,</span> <span class="n">Value</span><span class="o">&gt;</span> <span class="n">v</span><span class="p">);</span>

  <span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span>
  <span class="n">IValue</span><span class="p">(</span><span class="n">c10</span><span class="o">::</span><span class="n">optional</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">v</span><span class="p">);</span>
  <span class="n">IValue</span><span class="p">(</span><span class="n">c10</span><span class="o">::</span><span class="n">nullopt_t</span><span class="p">);</span>

  <span class="c1">// ClassType</span>
  <span class="n">IValue</span><span class="p">(</span><span class="n">c10</span><span class="o">::</span><span class="n">intrusive_ptr</span><span class="o">&lt;</span><span class="n">ivalue</span><span class="o">::</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">v</span><span class="p">);</span>
  <span class="kt">bool</span> <span class="nf">isObject</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">Tag</span><span class="o">::</span><span class="n">Object</span><span class="p">;</span> <span class="p">}</span>
  <span class="n">c10</span><span class="o">::</span><span class="n">intrusive_ptr</span><span class="o">&lt;</span><span class="n">ivalue</span><span class="o">::</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">toObject</span><span class="p">()</span> <span class="o">&amp;&amp;</span><span class="p">;</span>
  <span class="n">c10</span><span class="o">::</span><span class="n">intrusive_ptr</span><span class="o">&lt;</span><span class="n">ivalue</span><span class="o">::</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">toObject</span><span class="p">()</span> <span class="k">const</span> <span class="o">&amp;</span> <span class="p">;</span>
  <span class="k">const</span> <span class="n">ivalue</span><span class="o">::</span><span class="n">Object</span><span class="o">&amp;</span> <span class="n">toObjectRef</span><span class="p">()</span> <span class="k">const</span><span class="p">;</span>

  <span class="c1">// None</span>
  <span class="kt">bool</span> <span class="nf">isNone</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">Tag</span><span class="o">::</span><span class="n">None</span> <span class="o">==</span> <span class="n">tag</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">toNone</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
    <span class="n">AT_ASSERT</span><span class="p">(</span><span class="n">isNone</span><span class="p">());</span>
    <span class="k">return</span> <span class="s">&quot;None&quot;</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">static</span> <span class="n">IValue</span> <span class="n">uninitialized</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">auto</span> <span class="n">i</span> <span class="o">=</span> <span class="n">IValue</span><span class="p">();</span>
    <span class="n">i</span><span class="p">.</span><span class="n">tag</span> <span class="o">=</span> <span class="n">Tag</span><span class="o">::</span><span class="n">Uninitialized</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">i</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">// Scalar, which gets encoded as either an Int or a Double</span>
  <span class="n">IValue</span><span class="p">(</span><span class="n">at</span><span class="o">::</span><span class="n">Scalar</span> <span class="n">s</span><span class="p">)</span>
  <span class="o">:</span> <span class="n">IValue</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">isFloatingPoint</span><span class="p">())</span> <span class="p">{</span>
      <span class="o">*</span><span class="k">this</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="n">toDouble</span><span class="p">();</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="o">*</span><span class="k">this</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="n">toLong</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="kt">bool</span> <span class="n">isScalar</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">isDouble</span><span class="p">()</span> <span class="o">||</span> <span class="n">isInt</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="n">at</span><span class="o">::</span><span class="n">Scalar</span> <span class="n">toScalar</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">isDouble</span><span class="p">())</span>
      <span class="k">return</span> <span class="n">toDouble</span><span class="p">();</span>
    <span class="k">else</span> <span class="nf">if</span><span class="p">(</span><span class="n">isInt</span><span class="p">())</span>
      <span class="k">return</span> <span class="n">toInt</span><span class="p">();</span>
    <span class="k">throw</span> <span class="n">std</span><span class="o">::</span><span class="n">runtime_error</span><span class="p">(</span><span class="s">&quot;IValue is not a Scalar&quot;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">// Device</span>
  <span class="n">IValue</span><span class="p">(</span><span class="n">c10</span><span class="o">::</span><span class="n">Device</span> <span class="n">d</span><span class="p">)</span>
  <span class="o">:</span> <span class="n">tag</span><span class="p">(</span><span class="n">Tag</span><span class="o">::</span><span class="n">Device</span><span class="p">),</span> <span class="n">is_intrusive_ptr</span><span class="p">(</span><span class="nb">false</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">payload</span><span class="p">.</span><span class="n">as_device</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">d</span><span class="p">.</span><span class="n">type</span><span class="p">();</span>
    <span class="n">payload</span><span class="p">.</span><span class="n">as_device</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">d</span><span class="p">.</span><span class="n">index</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="kt">bool</span> <span class="n">isDevice</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">Tag</span><span class="o">::</span><span class="n">Device</span> <span class="o">==</span> <span class="n">tag</span><span class="p">;</span> <span class="p">}</span>
  <span class="n">c10</span><span class="o">::</span><span class="n">Device</span> <span class="n">toDevice</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
    <span class="n">AT_ASSERT</span><span class="p">(</span><span class="n">isDevice</span><span class="p">());</span>
    <span class="k">return</span> <span class="n">c10</span><span class="o">::</span><span class="n">Device</span><span class="p">(</span><span class="n">payload</span><span class="p">.</span><span class="n">as_device</span><span class="p">.</span><span class="n">type</span><span class="p">,</span> <span class="n">payload</span><span class="p">.</span><span class="n">as_device</span><span class="p">.</span><span class="n">index</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">// ScalarType</span>
  <span class="n">at</span><span class="o">::</span><span class="n">ScalarType</span> <span class="n">toScalarType</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">at</span><span class="o">::</span><span class="n">ScalarType</span><span class="o">&gt;</span><span class="p">(</span><span class="n">toInt</span><span class="p">());</span>
  <span class="p">}</span>

  <span class="c1">// Layout</span>
  <span class="n">at</span><span class="o">::</span><span class="n">Layout</span> <span class="n">toLayout</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">at</span><span class="o">::</span><span class="n">Layout</span><span class="o">&gt;</span><span class="p">(</span><span class="n">toInt</span><span class="p">());</span>
  <span class="p">}</span>

  <span class="c1">// MemoryFormat</span>
  <span class="n">at</span><span class="o">::</span><span class="n">MemoryFormat</span> <span class="n">toMemoryFormat</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">at</span><span class="o">::</span><span class="n">MemoryFormat</span><span class="o">&gt;</span><span class="p">(</span><span class="n">toInt</span><span class="p">());</span>
  <span class="p">}</span>

  <span class="c1">// QScheme</span>
  <span class="n">IValue</span><span class="p">(</span><span class="n">at</span><span class="o">::</span><span class="n">QScheme</span> <span class="n">qscheme</span><span class="p">)</span>
  <span class="o">:</span> <span class="n">tag</span><span class="p">(</span><span class="n">Tag</span><span class="o">::</span><span class="n">Int</span><span class="p">),</span> <span class="n">is_intrusive_ptr</span><span class="p">(</span><span class="nb">false</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">payload</span><span class="p">.</span><span class="n">as_int</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int64_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">qscheme</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">at</span><span class="o">::</span><span class="n">QScheme</span> <span class="n">toQScheme</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">at</span><span class="o">::</span><span class="n">QScheme</span><span class="o">&gt;</span><span class="p">(</span><span class="n">toInt</span><span class="p">());</span>
  <span class="p">}</span>


  <span class="c1">// for debugging</span>
  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">tagKind</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">switch</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span> <span class="p">{</span>
      <span class="cp">#define DEFINE_CASE(x) case Tag::x: return #x;</span>
      <span class="n">TORCH_FORALL_TAGS</span><span class="p">(</span><span class="n">DEFINE_CASE</span><span class="p">)</span>
      <span class="cp">#undef DEFINE_CASE</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="s">&quot;InvalidTag(&quot;</span> <span class="o">+</span> <span class="n">c10</span><span class="o">::</span><span class="n">guts</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">tag</span><span class="p">))</span> <span class="o">+</span> <span class="s">&quot;)&quot;</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">// generic v.to&lt;at::Tensor&gt;() implementations</span>
  <span class="c1">// that can be used in special functions like pop/push</span>
  <span class="c1">// that use template meta-programming.</span>
  <span class="c1">// prefer the directly named methods when you can,</span>
  <span class="c1">// since they are simpler to understand</span>

  <span class="c1">// Note: if you get linker errors saying one of these is missing,</span>
  <span class="c1">// change it to ... &amp;&amp; = delete; and you will see better error messages for why</span>
  <span class="c1">// However, we cannot commit this because some compiler versions barf on it.</span>
  <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
  <span class="n">T</span> <span class="n">to</span><span class="p">()</span> <span class="o">&amp;&amp;</span><span class="p">;</span>
  <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
  <span class="n">T</span> <span class="n">to</span><span class="p">()</span> <span class="k">const</span> <span class="o">&amp;</span><span class="p">;</span>

  <span class="c1">// ToOptional: convert a IValue to the Optional obj that accepts both T and None</span>
  <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
  <span class="n">optional</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">toOptional</span><span class="p">();</span>

  <span class="c1">// this is a shallow comparison of two IValues to test the object identity</span>
  <span class="kt">bool</span> <span class="nf">isSameIdentity</span><span class="p">(</span><span class="k">const</span> <span class="n">IValue</span><span class="o">&amp;</span> <span class="n">rhs</span><span class="p">)</span> <span class="k">const</span><span class="p">;</span>

  <span class="n">CAFFE2_API</span> <span class="k">friend</span> <span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&amp;</span> <span class="k">operator</span><span class="o">&lt;&lt;</span><span class="p">(</span>
      <span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&amp;</span> <span class="n">out</span><span class="p">,</span>
      <span class="k">const</span> <span class="n">IValue</span><span class="o">&amp;</span> <span class="n">v</span><span class="p">);</span>

  <span class="kt">bool</span> <span class="nf">isPtrType</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">is_intrusive_ptr</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">const</span> <span class="kt">void</span><span class="o">*</span> <span class="nf">internalToPointer</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
    <span class="n">TORCH_INTERNAL_ASSERT</span><span class="p">(</span><span class="n">isPtrType</span><span class="p">(),</span> <span class="s">&quot;Can only call internalToPointer() for pointer types&quot;</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">payload</span><span class="p">.</span><span class="n">as_intrusive_ptr</span><span class="p">;</span>
  <span class="p">}</span>

 <span class="k">private</span><span class="o">:</span>
  <span class="c1">// NOTE: IValue tags are intentionally private. In the future we may encode</span>
  <span class="c1">// this value different (e.g. using NaN boxing), and this would make it more</span>
  <span class="c1">// costly to determine the tag for all types vs just determining if something</span>
  <span class="c1">// is a particular type. Instead we want clients to use the `isX` methods when</span>
  <span class="c1">// possible. If for perf. reasons you really, absolutely, must have a jump</span>
  <span class="c1">// table, then we can revisit this.</span>
  <span class="k">enum</span> <span class="k">class</span> <span class="nc">Tag</span> <span class="o">:</span> <span class="kt">uint32_t</span> <span class="p">{</span>
<span class="cp">#define DEFINE_TAG(x) x,</span>
    <span class="n">TORCH_FORALL_TAGS</span><span class="p">(</span><span class="n">DEFINE_TAG</span><span class="p">)</span>
<span class="cp">#undef DEFINE_TAG</span>
  <span class="p">};</span>

  <span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="p">,</span> <span class="k">class</span> <span class="nc">NullType</span> <span class="o">=</span> <span class="n">c10</span><span class="o">::</span><span class="n">detail</span><span class="o">::</span><span class="n">intrusive_target_default_null_type</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span>
  <span class="n">c10</span><span class="o">::</span><span class="n">intrusive_ptr</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">NullType</span><span class="o">&gt;</span> <span class="n">moveToIntrusivePtr</span><span class="p">();</span>
  <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="p">,</span> <span class="k">class</span> <span class="nc">NullType</span> <span class="o">=</span> <span class="n">c10</span><span class="o">::</span><span class="n">detail</span><span class="o">::</span><span class="n">intrusive_target_default_null_type</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span>
  <span class="n">c10</span><span class="o">::</span><span class="n">intrusive_ptr</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">NullType</span><span class="o">&gt;</span> <span class="n">toIntrusivePtr</span><span class="p">()</span> <span class="k">const</span><span class="p">;</span>

  <span class="kt">void</span> <span class="nf">clearToNone</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">payload</span><span class="p">.</span><span class="n">as_int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">tag</span> <span class="o">=</span> <span class="n">Tag</span><span class="o">::</span><span class="n">None</span><span class="p">;</span>
    <span class="n">is_intrusive_ptr</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
  <span class="p">}</span>
<span class="k">private</span><span class="o">:</span>
  <span class="k">union</span> <span class="n">Payload</span> <span class="p">{</span>
    <span class="kt">int64_t</span> <span class="n">as_int</span><span class="p">;</span>
    <span class="kt">double</span> <span class="n">as_double</span><span class="p">;</span>
    <span class="kt">bool</span> <span class="n">as_bool</span><span class="p">;</span>
    <span class="n">c10</span><span class="o">::</span><span class="n">intrusive_ptr_target</span><span class="o">*</span> <span class="n">as_intrusive_ptr</span><span class="p">;</span>
    <span class="k">struct</span> <span class="p">{</span>
      <span class="n">DeviceType</span> <span class="n">type</span><span class="p">;</span>
      <span class="n">DeviceIndex</span> <span class="n">index</span><span class="p">;</span>
    <span class="p">}</span> <span class="n">as_device</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="n">IValue</span><span class="p">(</span><span class="n">Payload</span> <span class="n">p</span><span class="p">,</span> <span class="n">Tag</span> <span class="n">t</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">i</span><span class="p">)</span>
  <span class="o">:</span> <span class="n">payload</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="n">tag</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="n">is_intrusive_ptr</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{}</span>

  <span class="n">Payload</span> <span class="n">payload</span><span class="p">;</span>
  <span class="n">Tag</span> <span class="n">tag</span><span class="p">;</span>
  <span class="kt">bool</span> <span class="n">is_intrusive_ptr</span><span class="p">;</span>
  <span class="k">friend</span> <span class="k">struct</span> <span class="n">WeakIValue</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">CAFFE2_API</span> <span class="n">WeakIValue</span> <span class="k">final</span> <span class="p">{</span>
  <span class="n">WeakIValue</span><span class="p">()</span>
  <span class="o">:</span> <span class="n">payload</span><span class="p">{</span><span class="mi">0</span><span class="p">}</span>
  <span class="p">,</span> <span class="n">tag</span><span class="p">(</span><span class="n">IValue</span><span class="o">::</span><span class="n">Tag</span><span class="o">::</span><span class="n">None</span><span class="p">)</span>
  <span class="p">,</span> <span class="n">is_intrusive_ptr</span><span class="p">(</span><span class="nb">false</span><span class="p">)</span> <span class="p">{}</span>

  <span class="n">WeakIValue</span><span class="p">(</span><span class="k">const</span> <span class="n">WeakIValue</span><span class="o">&amp;</span> <span class="n">rhs</span><span class="p">)</span>
      <span class="o">:</span> <span class="n">payload</span><span class="p">(</span><span class="n">rhs</span><span class="p">.</span><span class="n">payload</span><span class="p">),</span>
        <span class="n">tag</span><span class="p">(</span><span class="n">rhs</span><span class="p">.</span><span class="n">tag</span><span class="p">),</span>
        <span class="n">is_intrusive_ptr</span><span class="p">(</span><span class="n">rhs</span><span class="p">.</span><span class="n">is_intrusive_ptr</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">is_intrusive_ptr</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">c10</span><span class="o">::</span><span class="n">raw</span><span class="o">::</span><span class="n">weak_intrusive_ptr</span><span class="o">::</span><span class="n">incref</span><span class="p">(</span><span class="n">payload</span><span class="p">.</span><span class="n">as_intrusive_ptr</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="n">WeakIValue</span><span class="p">(</span><span class="k">const</span> <span class="n">IValue</span><span class="o">&amp;</span> <span class="n">rhs</span><span class="p">)</span>
      <span class="o">:</span> <span class="n">payload</span><span class="p">(</span><span class="n">rhs</span><span class="p">.</span><span class="n">payload</span><span class="p">),</span>
        <span class="n">tag</span><span class="p">(</span><span class="n">rhs</span><span class="p">.</span><span class="n">tag</span><span class="p">),</span>
        <span class="n">is_intrusive_ptr</span><span class="p">(</span><span class="n">rhs</span><span class="p">.</span><span class="n">is_intrusive_ptr</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">is_intrusive_ptr</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">c10</span><span class="o">::</span><span class="n">raw</span><span class="o">::</span><span class="n">weak_intrusive_ptr</span><span class="o">::</span><span class="n">incref</span><span class="p">(</span><span class="n">payload</span><span class="p">.</span><span class="n">as_intrusive_ptr</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="n">WeakIValue</span><span class="p">(</span><span class="n">WeakIValue</span><span class="o">&amp;&amp;</span> <span class="n">rhs</span><span class="p">)</span> <span class="k">noexcept</span> <span class="o">:</span> <span class="n">WeakIValue</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">swap</span><span class="p">(</span><span class="n">rhs</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="o">~</span><span class="n">WeakIValue</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">is_intrusive_ptr</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">c10</span><span class="o">::</span><span class="n">raw</span><span class="o">::</span><span class="n">weak_intrusive_ptr</span><span class="o">::</span><span class="n">decref</span><span class="p">(</span><span class="n">payload</span><span class="p">.</span><span class="n">as_intrusive_ptr</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="n">WeakIValue</span> <span class="o">&amp;</span> <span class="k">operator</span><span class="o">=</span><span class="p">(</span><span class="n">WeakIValue</span> <span class="o">&amp;&amp;</span> <span class="n">rhs</span><span class="p">)</span> <span class="o">&amp;</span> <span class="k">noexcept</span> <span class="p">{</span>
    <span class="n">WeakIValue</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">rhs</span><span class="p">)).</span><span class="n">swap</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">);</span> <span class="c1">// this also sets rhs to None</span>
    <span class="k">return</span> <span class="o">*</span><span class="k">this</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">WeakIValue</span> <span class="o">&amp;</span> <span class="k">operator</span><span class="o">=</span><span class="p">(</span><span class="n">WeakIValue</span> <span class="k">const</span> <span class="o">&amp;</span> <span class="n">rhs</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">{</span>
    <span class="n">WeakIValue</span><span class="p">(</span><span class="n">rhs</span><span class="p">).</span><span class="n">swap</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">);</span>
    <span class="k">return</span> <span class="o">*</span><span class="k">this</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="kt">void</span> <span class="n">swap</span><span class="p">(</span><span class="n">WeakIValue</span> <span class="o">&amp;</span> <span class="n">rhs</span><span class="p">)</span> <span class="k">noexcept</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">swap</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">rhs</span><span class="p">.</span><span class="n">payload</span><span class="p">);</span>
    <span class="n">std</span><span class="o">::</span><span class="n">swap</span><span class="p">(</span><span class="n">is_intrusive_ptr</span><span class="p">,</span> <span class="n">rhs</span><span class="p">.</span><span class="n">is_intrusive_ptr</span><span class="p">);</span>
    <span class="n">std</span><span class="o">::</span><span class="n">swap</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">rhs</span><span class="p">.</span><span class="n">tag</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kt">bool</span> <span class="n">isSameIdentity</span><span class="p">(</span><span class="k">const</span> <span class="n">WeakIValue</span><span class="o">&amp;</span> <span class="n">rhs</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">payload</span><span class="p">.</span><span class="n">as_int</span> <span class="o">==</span> <span class="n">rhs</span><span class="p">.</span><span class="n">payload</span><span class="p">.</span><span class="n">as_int</span> <span class="o">&amp;&amp;</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">rhs</span><span class="p">.</span><span class="n">tag</span> <span class="o">&amp;&amp;</span>
        <span class="n">is_intrusive_ptr</span> <span class="o">==</span> <span class="n">rhs</span><span class="p">.</span><span class="n">is_intrusive_ptr</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">IValue</span> <span class="n">lock</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_intrusive_ptr</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="n">IValue</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">auto</span> <span class="n">temp</span> <span class="o">=</span> <span class="n">c10</span><span class="o">::</span><span class="n">weak_intrusive_ptr</span><span class="o">&lt;</span><span class="n">c10</span><span class="o">::</span><span class="n">intrusive_ptr_target</span><span class="o">&gt;::</span><span class="n">reclaim</span><span class="p">(</span>
        <span class="n">payload</span><span class="p">.</span><span class="n">as_intrusive_ptr</span><span class="p">);</span>
    <span class="n">IValue</span><span class="o">::</span><span class="n">Payload</span> <span class="n">pl</span><span class="p">;</span>
    <span class="n">pl</span><span class="p">.</span><span class="n">as_intrusive_ptr</span> <span class="o">=</span> <span class="n">temp</span><span class="p">.</span><span class="n">lock</span><span class="p">().</span><span class="n">release</span><span class="p">();</span>
    <span class="n">temp</span><span class="p">.</span><span class="n">release</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pl</span><span class="p">.</span><span class="n">as_intrusive_ptr</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="n">IValue</span><span class="p">();</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">return</span> <span class="n">IValue</span><span class="p">(</span><span class="n">pl</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="kt">size_t</span> <span class="n">use_count</span><span class="p">()</span> <span class="k">const</span> <span class="k">noexcept</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_intrusive_ptr</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">auto</span> <span class="n">temp</span> <span class="o">=</span> <span class="n">c10</span><span class="o">::</span><span class="n">weak_intrusive_ptr</span><span class="o">&lt;</span><span class="n">c10</span><span class="o">::</span><span class="n">intrusive_ptr_target</span><span class="o">&gt;::</span><span class="n">reclaim</span><span class="p">(</span>
        <span class="n">payload</span><span class="p">.</span><span class="n">as_intrusive_ptr</span><span class="p">);</span>
    <span class="kt">size_t</span> <span class="n">result</span> <span class="o">=</span> <span class="n">temp</span><span class="p">.</span><span class="n">use_count</span><span class="p">();</span>
    <span class="n">temp</span><span class="p">.</span><span class="n">release</span><span class="p">();</span>
    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kt">size_t</span> <span class="n">weak_use_count</span><span class="p">()</span> <span class="k">const</span> <span class="k">noexcept</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_intrusive_ptr</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">auto</span> <span class="n">temp</span> <span class="o">=</span> <span class="n">c10</span><span class="o">::</span><span class="n">weak_intrusive_ptr</span><span class="o">&lt;</span><span class="n">c10</span><span class="o">::</span><span class="n">intrusive_ptr_target</span><span class="o">&gt;::</span><span class="n">reclaim</span><span class="p">(</span>
        <span class="n">payload</span><span class="p">.</span><span class="n">as_intrusive_ptr</span><span class="p">);</span>
    <span class="kt">size_t</span> <span class="n">result</span> <span class="o">=</span> <span class="n">temp</span><span class="p">.</span><span class="n">weak_use_count</span><span class="p">();</span>
    <span class="n">temp</span><span class="p">.</span><span class="n">release</span><span class="p">();</span>
    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="kt">size_t</span> <span class="n">hash</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">payload</span><span class="p">.</span><span class="n">as_int</span><span class="p">;</span>
  <span class="p">}</span>

<span class="k">private</span><span class="o">:</span>
  <span class="n">IValue</span><span class="o">::</span><span class="n">Payload</span> <span class="n">payload</span><span class="p">;</span>
  <span class="n">IValue</span><span class="o">::</span><span class="n">Tag</span> <span class="n">tag</span><span class="p">;</span>
  <span class="kt">bool</span> <span class="n">is_intrusive_ptr</span><span class="p">;</span>
<span class="p">};</span>

<span class="p">}</span>

<span class="cp">#include</span> <span class="cpf">&lt;ATen/core/ivalue_inl.h&gt;</span><span class="cp"></span>
</pre></div>
</div>
</div>


             </article>
             
            </div>
            <footer>
  

  

    <hr>

  

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Torch Contributors.

    </p>
  </div>
    
      <div>
        Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
      </div>
     

</footer>

          </div>
        </div>

        <div class="pytorch-content-right" id="pytorch-content-right">
          <div class="pytorch-right-menu" id="pytorch-right-menu">
            <div class="pytorch-side-scroll" id="pytorch-side-scroll-right">
              <ul>
<li><a class="reference internal" href="#">Program Listing for File ivalue.h</a></li>
</ul>

            </div>
          </div>
        </div>
      </section>
    </div>

  


  

     
       <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
         <script type="text/javascript" src="../_static/jquery.js"></script>
         <script type="text/javascript" src="../_static/underscore.js"></script>
         <script type="text/javascript" src="../_static/doctools.js"></script>
         <script type="text/javascript" src="../_static/language_data.js"></script>
         <script type="text/javascript" src="../_static/collapsible-lists/js/CollapsibleLists.compressed.js"></script>
         <script type="text/javascript" src="../_static/collapsible-lists/js/apply-collapsible-lists.js"></script>
     

  

  <script type="text/javascript" src="../_static/js/vendor/popper.min.js"></script>
  <script type="text/javascript" src="../_static/js/vendor/bootstrap.min.js"></script>
  <script type="text/javascript" src="../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

  <!-- Begin Footer -->

  <div class="container-fluid docs-tutorials-resources" id="docs-tutorials-resources">
    <div class="container">
      <div class="row">
        <div class="col-md-4 text-center">
          <h2>Docs</h2>
          <p>Access comprehensive developer documentation for PyTorch</p>
          <a class="with-right-arrow" href="https://pytorch.org/docs/stable/index.html">View Docs</a>
        </div>

        <div class="col-md-4 text-center">
          <h2>Tutorials</h2>
          <p>Get in-depth tutorials for beginners and advanced developers</p>
          <a class="with-right-arrow" href="https://pytorch.org/tutorials">View Tutorials</a>
        </div>

        <div class="col-md-4 text-center">
          <h2>Resources</h2>
          <p>Find development resources and get your questions answered</p>
          <a class="with-right-arrow" href="https://pytorch.org/resources">View Resources</a>
        </div>
      </div>
    </div>
  </div>

  <footer class="site-footer">
    <div class="container footer-container">
      <div class="footer-logo-wrapper">
        <a href="https://pytorch.org/" class="footer-logo"></a>
      </div>

      <div class="footer-links-wrapper">
        <div class="footer-links-col">
          <ul>
            <li class="list-title"><a href="https://pytorch.org/">PyTorch</a></li>
            <li><a href="https://pytorch.org/get-started">Get Started</a></li>
            <li><a href="https://pytorch.org/features">Features</a></li>
            <li><a href="https://pytorch.org/ecosystem">Ecosystem</a></li>
            <li><a href="https://pytorch.org/blog/">Blog</a></li>
            <li><a href="https://pytorch.org/resources">Resources</a></li>
          </ul>
        </div>

        <div class="footer-links-col">
          <ul>
            <li class="list-title"><a href="https://pytorch.org/support">Support</a></li>
            <li><a href="https://pytorch.org/tutorials">Tutorials</a></li>
            <li><a href="https://pytorch.org/docs/stable/index.html">Docs</a></li>
            <li><a href="https://discuss.pytorch.org" target="_blank">Discuss</a></li>
            <li><a href="https://github.com/pytorch/pytorch/issues" target="_blank">Github Issues</a></li>
            <li><a href="https://pytorch.slack.com" target="_blank">Slack</a></li>
            <li><a href="https://github.com/pytorch/pytorch/blob/master/CONTRIBUTING.md" target="_blank">Contributing</a></li>
          </ul>
        </div>

        <div class="footer-links-col follow-us-col">
          <ul>
            <li class="list-title">Follow Us</li>
            <li>
              <div id="mc_embed_signup">
                <form
                  action="https://twitter.us14.list-manage.com/subscribe/post?u=75419c71fe0a935e53dfa4a3f&id=91d0dccd39"
                  method="post"
                  id="mc-embedded-subscribe-form"
                  name="mc-embedded-subscribe-form"
                  class="email-subscribe-form validate"
                  target="_blank"
                  novalidate>
                  <div id="mc_embed_signup_scroll" class="email-subscribe-form-fields-wrapper">
                    <div class="mc-field-group">
                      <label for="mce-EMAIL" style="display:none;">Email Address</label>
                      <input type="email" value="" name="EMAIL" class="required email" id="mce-EMAIL" placeholder="Email Address">
                    </div>

                    <div id="mce-responses" class="clear">
                      <div class="response" id="mce-error-response" style="display:none"></div>
                      <div class="response" id="mce-success-response" style="display:none"></div>
                    </div>    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->

                    <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_75419c71fe0a935e53dfa4a3f_91d0dccd39" tabindex="-1" value=""></div>

                    <div class="clear">
                      <input type="submit" value="" name="subscribe" id="mc-embedded-subscribe" class="button email-subscribe-button">
                    </div>
                  </div>
                </form>
              </div>

            </li>
          </ul>

          <div class="footer-social-icons">
            <a href="https://www.facebook.com/pytorch" target="_blank" class="facebook"></a>
            <a href="https://twitter.com/pytorch" target="_blank" class="twitter"></a>
          </div>
        </div>
      </div>
    </div>
  </footer>

  <div class="cookie-banner-wrapper">
  <div class="container">
    <p class="gdpr-notice">To analyze traffic and optimize your experience, we serve cookies on this site. By clicking or navigating, you agree to allow our usage of cookies. As the current maintainers of this site, Facebook’s Cookies Policy applies. Learn more, including about available controls: <a href="https://www.facebook.com/policies/cookies/">Cookies Policy</a>.</p>
    <img class="close-button" src="../_static/images/pytorch-x.svg">
  </div>
</div>

  <!-- End Footer -->

  <!-- Begin Mobile Menu -->

  <div class="mobile-main-menu">
    <div class="container-fluid">
      <div class="container">
        <div class="mobile-main-menu-header-container">
          <a class="header-logo" href="https://pytorch.org/" aria-label="PyTorch"></a>
          <a class="main-menu-close-button" href="#" data-behavior="close-mobile-menu"></a>
        </div>
      </div>
    </div>

    <div class="mobile-main-menu-links-container">
      <div class="main-menu">
        <ul>
          <li>
            <a href="#">Get Started</a>
          </li>

          <li>
            <a href="#">Features</a>
          </li>

          <li>
            <a href="#">Ecosystem</a>
          </li>

          <li>
            <a href="https://pytorch.org/blog/">Blog</a>
          </li>

          <li>
            <a href="https://pytorch.org/tutorials">Tutorials</a>
          </li>

          <li class="active">
            <a href="https://pytorch.org/docs/stable/index.html">Docs</a>
          </li>

          <li>
            <a href="https://pytorch.org/resources">Resources</a>
          </li>

          <li>
            <a href="https://github.com/pytorch/pytorch">Github</a>
          </li>
        </ul>
      </div>
    </div>
  </div>

  <!-- End Mobile Menu -->

  <script type="text/javascript" src="../_static/js/vendor/anchor.min.js"></script>

  <script type="text/javascript">
    $(document).ready(function() {
      mobileMenu.bind();
      mobileTOC.bind();
      pytorchAnchors.bind();
      sideMenus.bind();
      scrollToAnchor.bind();
      highlightNavigation.bind();

      // Add class to links that have code blocks, since we cannot create links in code blocks
      $("article.pytorch-article a span.pre").each(function(e) {
        $(this).closest("a").addClass("has-code");
      });
    })
  </script>
</body>
</html>